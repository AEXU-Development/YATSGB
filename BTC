# Source code if you're curious

import discord
from discord.ext import commands
from discord import app_commands
import json
import os
from datetime import datetime
import requests

# === CONFIG ===
TOKEN = "Not giving out my bot token :^"
DATA_FILE = "data.json"
TORN_API_BASE = "https://api.torn.com/user/"

# === DISCORD BOT SETUP ===
intents = discord.Intents.default()
intents.guilds = True
intents.message_content = True
intents.members = True
bot = commands.Bot(command_prefix=commands.when_mentioned, intents=intents)

# === LOAD/SAVE USER DATA ===
if os.path.exists(DATA_FILE):
    with open(DATA_FILE, "r") as f:
        user_data = json.load(f)
    channel_limits = user_data.get("channel_limits", {})
else:
    user_data = {}
    channel_limits = {}

def save_data():
    user_data["channel_limits"] = channel_limits
    with open(DATA_FILE, "w") as f:
        json.dump(user_data, f)

def is_channel_allowed(interaction: discord.Interaction):
    guild_id = str(interaction.guild_id)
    if guild_id not in channel_limits:
        return True
    return str(interaction.channel_id) in channel_limits[guild_id]

def format_dynamic_timestamp(dt: datetime):
    return f"<t:{int(dt.timestamp())}:f>"

def compute_effective(stat_value, modifier):
    return int(stat_value * (1 + modifier / 100))

def fetch_user(api_key: str, user_id: int, selections: str = "basic,battlestats"):
    url = f"{TORN_API_BASE}{user_id}?selections={selections}&key={api_key}"
    resp = requests.get(url, timeout=10)
    if resp.status_code != 200:
        raise Exception(f"Torn API request failed with status {resp.status_code}")
    return resp.json()

# === ON READY ===
@bot.event
async def on_ready():
    await bot.tree.sync()

@bot.event
async def on_guild_join(guild):
    pass

# === /saveid ===
@bot.tree.command(name="saveid", description="Save your Torn user ID and API key")
@app_commands.describe(torn_id="Your Torn user ID", api_key="Your Torn API key")
async def saveid(interaction: discord.Interaction, torn_id: int, api_key: str):
    user_data[str(interaction.user.id)] = {"torn_id": torn_id, "api_key": api_key}
    save_data()
    await interaction.response.send_message("Your Torn ID and API key have been saved.", ephemeral=True)

# === /stats ===
@bot.tree.command(name="stats", description="View Torn stats for yourself or another user")
@app_commands.describe(user="Discord user to view stats for (optional)")
async def stats(interaction: discord.Interaction, user: discord.User = None):
    if not is_channel_allowed(interaction):
        await interaction.response.send_message("This command is not allowed in this channel.", ephemeral=True)
        return

    target = user or interaction.user
    target_id = str(target.id)

    if target_id not in user_data:
        await interaction.response.send_message(f"{target.display_name} has not saved their Torn ID yet.", ephemeral=True)
        return

    api_info = user_data[target_id]

    try:
        data = fetch_user(api_info["api_key"], api_info["torn_id"], selections="basic,battlestats,personalstats")
    except:
        await interaction.response.send_message("Could not fetch data from Torn API.", ephemeral=True)
        return

    bs = data.get("battlestats") or data
    personal = data.get("personalstats", {})

    name = data.get("name", target.display_name)
    level = data.get("level", "N/A")
    xans_used = personal.get("xantaken", 0)

    stats_base = {
        "Strength": bs.get("strength", 0),
        "Defense": bs.get("defense", 0),
        "Speed": bs.get("speed", 0),
        "Dexterity": bs.get("dexterity", 0)
    }

    modifiers = {
        "Strength": bs.get("strength_modifier", 0),
        "Defense": bs.get("defense_modifier", 0),
        "Speed": bs.get("speed_modifier", 0),
        "Dexterity": bs.get("dexterity_modifier", 0)
    }

    effective_stats = {s: compute_effective(stats_base[s], modifiers[s]) for s in stats_base}
    total_base = sum(stats_base.values())
    total_effective = sum(effective_stats.values())

    prev_snapshot = user_data[target_id].get("last_stats", {})
    prev_stats = prev_snapshot.get("stats", {})

    now = datetime.utcnow()
    user_data[target_id]["last_stats"] = {
        "stats": stats_base,
        "effective": effective_stats,
        "timestamp": now.isoformat()
    }
    save_data()

    xan_active = False
    for stat in ["strength", "defense", "speed", "dexterity"]:
        info_key = f"{stat}_info"
        info_list = bs.get(info_key, []) or []
        if any("-33% to" in str(i) and "Drug" in str(i) for i in info_list):
            xan_active = True
            break

    xans_text = f"{xans_used} (Xanax debuff active)" if xan_active else str(xans_used)

    lines = [
        f"**{name}**     Lvl: {level}",
        f"**Xanax used:** {xans_text}",
        ""
    ]

    for stat in ["Strength", "Defense", "Speed", "Dexterity"]:
        base = stats_base[stat]
        eff = effective_stats[stat]
        mod = modifiers[stat]
        pct = f"{mod:+d}%"
        line = f"{stat}: {base:,} ({pct}︱{eff:,})"

        if prev_stats:
            diff = base - prev_stats.get(stat, base)
            if diff != 0:
                ts = prev_snapshot.get("timestamp")
                ts_fmt = format_dynamic_timestamp(datetime.fromisoformat(ts)) if ts else "last save"
                line += f"\n       {diff:+,} since {ts_fmt}"

        lines.append(line)
        lines.append("")

    total_line = f"Total: {total_base:,} ({total_effective:,})"
    if prev_stats:
        prev_total = sum(prev_stats.values())
        diff_total = total_base - prev_total
        if diff_total != 0:
            ts = prev_snapshot.get("timestamp")
            ts_fmt = format_dynamic_timestamp(datetime.fromisoformat(ts)) if ts else "last save"
            total_line += f"\n       {diff_total:+,} since {ts_fmt}"

    lines.append(total_line)
    await interaction.response.send_message("\n".join(lines))

# === /total ===
@bot.tree.command(name="total", description="Show total combined stats of saved users in this server")
async def total(interaction: discord.Interaction):
    if not is_channel_allowed(interaction):
        await interaction.response.send_message("This command is not allowed in this channel.", ephemeral=True)
        return

    await interaction.response.defer()
    server_id = str(interaction.guild.id)
    server_members = {str(m.id) for m in interaction.guild.members}
    targets = {uid: info for uid, info in user_data.items() if uid in server_members and "torn_id" in info}
    if not targets:
        await interaction.followup.send("No saved users from this server.")
        return

    totals_base = {s: 0 for s in ["Strength", "Defense", "Speed", "Dexterity"]}
    contributors = []

    for uid, info in targets.items():
        try:
            data = fetch_user(info["api_key"], info["torn_id"], selections="battlestats")
            bs = data.get("battlestats") or data
            member_name = data.get("name") or interaction.guild.get_member(int(uid)).display_name
            contributors.append(f"`{member_name}`")
            for stat in totals_base:
                totals_base[stat] += bs.get(stat.lower(), 0)
        except:
            continue

    total_sum = sum(totals_base.values())
    prev = user_data.get(server_id, {}).get("last_total", None)
    now = datetime.utcnow()
    user_data.setdefault(server_id, {})["last_total"] = {
        "totals_base": totals_base,
        "timestamp": now.isoformat()
    }
    save_data()

    lines = ["**Server Total Stats**", "", "Contributors: " + ", ".join(contributors), ""]
    for stat in ["Strength", "Defense", "Speed", "Dexterity"]:
        line = f"{stat}: {totals_base[stat]:,}"
        if prev:
            delta = totals_base[stat] - prev["totals_base"].get(stat, 0)
            if delta != 0:
                line += f"\n       {delta:+,} since last check"
        lines.append(line)
        lines.append("")

    total_line = f"Total: {total_sum:,}"
    if prev:
        prev_sum = sum(prev["totals_base"].values())
        delta_sum = total_sum - prev_sum
        if delta_sum != 0:
            total_line += f"\n       {delta_sum:+,} since last check"
    lines.append(total_line)

    await interaction.followup.send("\n".join(lines))

# === /limit ===
@bot.tree.command(name="limit", description="Restrict bot usage to this channel")
async def limit(interaction: discord.Interaction):
    guild_id = str(interaction.guild_id)
    channel_id = str(interaction.channel_id)
    channel_limits.setdefault(guild_id, [])
    if channel_id not in channel_limits[guild_id]:
        channel_limits[guild_id].append(channel_id)
        save_data()
        await interaction.response.send_message("This channel is now limited.", ephemeral=True)
    else:
        await interaction.response.send_message("Channel already limited.", ephemeral=True)

# === /removelimit ===
@bot.tree.command(name="removelimit", description="Remove this channel from the bot limit list")
async def removelimit(interaction: discord.Interaction):
    guild_id = str(interaction.guild_id)
    channel_id = str(interaction.channel_id)
    if guild_id in channel_limits and channel_id in channel_limits[guild_id]:
        channel_limits[guild_id].remove(channel_id)
        if not channel_limits[guild_id]:
            del channel_limits[guild_id]
        save_data()
        await interaction.response.send_message("Channel removed from limit.", ephemeral=True)
    else:
        await interaction.response.send_message("This channel is not limited.", ephemeral=True)

# === /help ===
@bot.tree.command(name="help", description="How to get help with using the bot")
async def help_command(interaction: discord.Interaction):
    await interaction.response.send_message(
        "To get help, just mention the bot by @-ing it in any channel.",
        ephemeral=True
    )

# === @message ===
@bot.event
async def on_message(message):
    if message.author.bot:
        return
    if bot.user in message.mentions:
        help_msg = (
            f"Hello {message.author.mention}!\nThis is the help-board.\n\n"
            "**/saveid** - Save your Torn ID so others can view your battle stats\n"
            "**/stats** - View IGN, level, battle stats, total stats, and Xanax used\n"
            "**/total** - Show each saved user's total stats and the total combined stats across the server\n"
            "**/limit** - Restricts the bot's usage to specific channels\n"
            "**/removelimit** - Removes a limited channel\n\n"
            "*/stats and /total only return the stats of users currently in the server*\n"
            "*For inquiries or suggestions, DM <@986769111667326998>. For further help:* **YATSGB - <https://discord.gg/sXxrQeXfk3>**"
        )
        try:
            await message.author.send(help_msg)
            await message.channel.send(f"{message.author.mention} I’ve sent you a DM with help information.")
        except discord.Forbidden:
            await message.channel.send(f"{message.author.mention} I couldn’t DM you. Please enable DMs.")
    await bot.process_commands(message)

# === RUN BOT ===
bot.run(TOKEN)
